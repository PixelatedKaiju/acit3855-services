<script>
    // Configuration - Update these URLs to match your Cloud VM
    const CONFIG = {
        processingStatsUrl: 'http://135.237.187.62:8100/stats',
        analyzerStatsUrl: 'http://135.237.187.62:8110/stats',
        searchEventUrl: 'http://135.237.187.62:8110/search',
        purchaseEventUrl: 'http://135.237.187.62:8110/purchase',
        updateInterval: 3000 // 3 seconds
    };

    // Fetch processing statistics
    async function fetchProcessingStats() {
        try {
            const response = await fetch(CONFIG.processingStatsUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            displayProcessingStats(data);
        } catch (error) {
            document.getElementById('processingStats').innerHTML = 
                `<div class="error">Error loading processing stats: ${error.message}</div>`;
        }
    }

    function displayProcessingStats(stats) {
        const html = `
            <div class="stat-row">
                <span class="stat-label">Total Search Readings:</span>
                <span class="stat-value">${stats.num_search_readings || 0}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Max Search Count:</span>
                <span class="stat-value">${stats.max_search_count || 0}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Purchase Readings:</span>
                <span class="stat-value">${stats.num_purchase_readings || 0}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Max Purchase Count:</span>
                <span class="stat-value">${stats.max_purchase_count || 0}</span>
            </div>
        `;
        document.getElementById('processingStats').innerHTML = html;

        if (stats.last_updated) {
            document.getElementById('lastUpdate').textContent = 
                new Date(stats.last_updated).toLocaleString();
        }
    }

    // Fetch analyzer statistics
    async function fetchAnalyzerStats() {
        try {
            const response = await fetch(CONFIG.analyzerStatsUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            displayAnalyzerStats(data);
        } catch (error) {
            document.getElementById('analyzerStats').innerHTML = 
                `<div class="error">Error loading analyzer stats: ${error.message}</div>`;
        }
    }

    function displayAnalyzerStats(stats) {
        const html = `
            <div class="stat-row">
                <span class="stat-label">Total Search Events:</span>
                <span class="stat-value">${stats.num_search_readings || 0}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Purchase Events:</span>
                <span class="stat-value">${stats.num_purchase_readings || 0}</span>
            </div>
        `;
        document.getElementById('analyzerStats').innerHTML = html;
    }

    // Fetch a random search event
    async function fetchSearchEvent() {
        try {
            const statsResponse = await fetch(CONFIG.analyzerStatsUrl);
            const stats = await statsResponse.json();
            
            if (stats.num_search_readings === 0) {
                document.getElementById('searchEvent').innerHTML = 
                    '<div class="event-card">No search events available yet</div>';
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * stats.num_search_readings);
            const response = await fetch(`${CONFIG.searchEventUrl}/${randomIndex}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const event = await response.json();
            displaySearchEvent(event);
        } catch (error) {
            document.getElementById('searchEvent').innerHTML = 
                `<div class="error">Error loading search event: ${error.message}</div>`;
        }
    }

    function displaySearchEvent(event) {
        const html = `
            <div class="event-card">
                <div class="event-detail"><strong>Trace ID:</strong> ${event.trace_id}</div>
                <div class="event-detail"><strong>Store:</strong> ${event.store_name} (ID: ${event.store_id})</div>
                <div class="event-detail"><strong>Product ID:</strong> ${event.product_id}</div>
                <div class="event-detail"><strong>Search Count:</strong> ${event.search_count}</div>
                <div class="event-detail"><strong>Recorded:</strong> ${event.recorded_timestamp}</div>
            </div>
        `;
        document.getElementById('searchEvent').innerHTML = html;
    }

    // Fetch a random purchase event
    async function fetchPurchaseEvent() {
        try {
            const statsResponse = await fetch(CONFIG.analyzerStatsUrl);
            const stats = await statsResponse.json();
            
            if (stats.num_purchase_readings === 0) {
                document.getElementById('purchaseEvent').innerHTML = 
                    '<div class="event-card">No purchase events available yet</div>';
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * stats.num_purchase_readings);
            const response = await fetch(`${CONFIG.purchaseEventUrl}/${randomIndex}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const event = await response.json();
            displayPurchaseEvent(event);
        } catch (error) {
            document.getElementById('purchaseEvent').innerHTML = 
                `<div class="error">Error loading purchase event: ${error.message}</div>`;
        }
    }

    function displayPurchaseEvent(event) {
        const html = `
            <div class="event-card">
                <div class="event-detail"><strong>Trace ID:</strong> ${event.trace_id}</div>
                <div class="event-detail"><strong>Store:</strong> ${event.store_name} (ID: ${event.store_id})</div>
                <div class="event-detail"><strong>Product ID:</strong> ${event.product_id}</div>
                <div class="event-detail"><strong>Purchase Count:</strong> ${event.purchase_count}</div>
                <div class="event-detail"><strong>Recorded:</strong> ${event.recorded_timestamp}</div>
            </div>
        `;
        document.getElementById('purchaseEvent').innerHTML = html;
    }

    function updateDashboard() {
        fetchProcessingStats();
        fetchAnalyzerStats();
        fetchSearchEvent();
        fetchPurchaseEvent();
    }

    updateDashboard();
    setInterval(updateDashboard, CONFIG.updateInterval);
</script>
