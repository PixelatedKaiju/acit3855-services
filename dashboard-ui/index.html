<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery System Dashboard</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .logo {
            width: 100px; height: 100px; margin: 0 auto 20px;
            background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3em;
        }
        .dashboard-grid {
            display: grid; gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            margin-bottom: 20px;
        }
        .card {
            background: white; padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #667eea; margin-bottom: 15px;
            border-bottom: 2px solid #667eea; padding-bottom: 10px;
        }
        .stat-row {
            display: flex; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid #eee;
        }
        .event-card {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border-left: 4px solid #667eea; margin-top: 10px;
        }
        .event-detail { margin: 5px 0; font-size: 0.9em; }
        .error {
            background: #fadbd8; color: #e74c3c;
            padding: 10px; border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="header">
            <div class="logo">ðŸ›’</div>
            <h1>Grocery Analytics Dashboard</h1>
            <div>Last Updated: <span id="lastUpdate">Loading...</span></div>
        </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>Processing Statistics</h2>
            <div id="processingStats">Loadingâ€¦</div>
        </div>

        <div class="card">
            <h2>Analyzer Statistics</h2>
            <div id="analyzerStats">Loadingâ€¦</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>Health Status</h2>
            <div id="healthStatus">Loadingâ€¦</div>
        </div>
    </div>   

    <div class="dashboard-grid">
        <div class="card">
            <h2>Recent Search Event</h2>
            <div id="searchEvent">Loadingâ€¦</div>
        </div>

        <div class="card">
            <h2>Recent Purchase Event</h2>
            <div id="purchaseEvent">Loadingâ€¦</div>
        </div>
    </div>

<script>
    // Correct API paths based on your grocery_api.yml
    const CONFIG = {
        processingStatsUrl: 'http://localhost:8100/stats',
        analyzerStatsUrl: 'http://localhost:8110/stats',
        searchEventUrl: 'http://localhost:8110/product/search?index=',
        purchaseEventUrl: 'http://localhost:8110/product/sold?index=',
        healthStatusUrl: 'http://localhost:8120/health/status',
        updateInterval: 3000
    };

    async function fetchProcessingStats() {
        try {
            const res = await fetch(CONFIG.processingStatsUrl);
            const data = await res.json();
            document.getElementById('processingStats').innerHTML = `
                <div class="stat-row"><b>Total Search Readings:</b><span>${data.num_search_readings}</span></div>
                <div class="stat-row"><b>Max Search Count:</b><span>${data.max_search_count}</span></div>
                <div class="stat-row"><b>Total Purchase Readings:</b><span>${data.num_purchase_readings}</span></div>
                <div class="stat-row"><b>Max Purchase Count:</b><span>${data.max_purchase_count}</span></div>
            `;
            if (data.last_updated) {
                document.getElementById('lastUpdate').innerText =
                    new Date(data.last_updated).toLocaleString();
            }
        } catch {
            document.getElementById('processingStats').innerHTML =
                `<div class="error">Unable to load stats</div>`;
        }
    }

    async function fetchAnalyzerStats() {
        try {
            const res = await fetch(CONFIG.analyzerStatsUrl);
            const data = await res.json();
            document.getElementById('analyzerStats').innerHTML = `
                <div class="stat-row"><b>Total Search Events:</b><span>${data.num_search_readings}</span></div>
                <div class="stat-row"><b>Total Purchase Events:</b><span>${data.num_purchase_readings}</span></div>
            `;
        } catch {
            document.getElementById('analyzerStats').innerHTML =
                `<div class="error">Unable to load analyzer stats</div>`;
        }
    }

    async function fetchSearchEvent() {
        try {
            const stats = await (await fetch(CONFIG.analyzerStatsUrl)).json();
            if (stats.num_search_readings === 0)
                return document.getElementById('searchEvent').innerHTML =
                    `<div>No search events yet</div>`;

            const index = Math.floor(Math.random() * stats.num_search_readings);
            const event = await (await fetch(CONFIG.searchEventUrl + index)).json();
            if (event.message)
                return document.getElementById('searchEvent').innerHTML =
                    `<div class="error">${event.message}</div>`;

            document.getElementById('searchEvent').innerHTML = `
                <div class="event-card">
                    <div class="event-detail"><b>Trace ID:</b> ${event.trace_id}</div>
                    <div class="event-detail"><b>Store:</b> ${event.store_name}</div>
                    <div class="event-detail"><b>Product ID:</b> ${event.product_id}</div>
                    <div class="event-detail"><b>Search Count:</b> ${event.search_count}</div>
                </div>`;
        } catch {
            document.getElementById('searchEvent').innerHTML =
                `<div class="error">Unable to load search event</div>`;
        }
    }

    async function fetchPurchaseEvent() {
        try {
            const stats = await (await fetch(CONFIG.analyzerStatsUrl)).json();
            if (stats.num_purchase_readings === 0)
                return document.getElementById('purchaseEvent').innerHTML =
                    `<div>No purchase events yet</div>`;

            const index = Math.floor(Math.random() * stats.num_purchase_readings);
            const event = await (await fetch(CONFIG.purchaseEventUrl + index)).json();
            if (event.message)
                return document.getElementById('purchaseEvent').innerHTML =
                    `<div class="error">${event.message}</div>`;

            document.getElementById('purchaseEvent').innerHTML = `
                <div class="event-card">
                    <div class="event-detail"><b>Trace ID:</b> ${event.trace_id}</div>
                    <div class="event-detail"><b>Store:</b> ${event.store_name}</div>
                    <div class="event-detail"><b>Product ID:</b> ${event.product_id}</div>
                    <div class="event-detail"><b>Purchase Count:</b> ${event.purchase_count}</div>
                </div>`;
        } catch {
            document.getElementById('purchaseEvent').innerHTML =
                `<div class="error">Unable to load purchase event</div>`;
        }
    }

    async function fetchHealthStatus() {
        try {
            const res = await fetch(CONFIG.healthStatusUrl);
            const data = await res.json();

            document.getElementById('healthStatus').innerHTML = `
                <div class="stat-row"><b>Receiver:</b> <span>${data.receiver}</span></div>
                <div class="stat-row"><b>Storage:</b> <span>${data.storage}</span></div>
                <div class="stat-row"><b>Processing:</b> <span>${data.processing}</span></div>
                <div class="stat-row"><b>Analyzer:</b> <span>${data.analyzer}</span></div>
                <div class="stat-row"><b>Last Update:</b> <span>${new Date(data.last_update).toLocaleString()}</span></div>
            `;
        } catch {
            document.getElementById('healthStatus').innerHTML =
                `<div class="error">Unable to load health status</div>`;
        }
    }


    function updateDashboard() {
        fetchProcessingStats();
        fetchAnalyzerStats();
        fetchSearchEvent();
        fetchPurchaseEvent();
        fetchHealthStatus();
    }

    updateDashboard();
    setInterval(updateDashboard, CONFIG.updateInterval);
</script>

    </div>

</body>
</html>
